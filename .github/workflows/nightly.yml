name: Nightly Tests

on:
    schedule:
        # Run at 2 AM UTC every day
        - cron: '0 2 * * *'
    workflow_dispatch: # Allow manual trigger

jobs:
    test:
        timeout-minutes: 60
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'

            - name: Install dependencies
              run: npm ci

            - name: Install Playwright Browsers
              run: npx playwright install --with-deps chromium

            - name: Create .env file
              run: |
                  cat > .env << 'EOF'
                  # AI Provider Configuration
                  AI_PROVIDER=${{ secrets.AI_PROVIDER }}
                  OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
                  AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}
                  AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}
                  AZURE_OPENAI_DEPLOYMENT_NAME=${{ secrets.AZURE_OPENAI_DEPLOYMENT_NAME }}

                  # Bug Tracker Configuration
                  BUG_TRACKER_PROVIDER=${{ secrets.BUG_TRACKER_PROVIDER }}
                  GITHUB_TOKEN=${{ secrets.GH_PAT }}
                  GITHUB_REPO=${{ secrets.GITHUB_REPO }}
                  ADO_PERSONAL_ACCESS_TOKEN=${{ secrets.ADO_PERSONAL_ACCESS_TOKEN }}
                  ADO_ORGANIZATION_URL=${{ secrets.ADO_ORGANIZATION_URL }}
                  ADO_PROJECT=${{ secrets.ADO_PROJECT }}

                  # PR Provider Configuration
                  PR_PROVIDER=${{ secrets.PR_PROVIDER }}

                  # Database Configuration
                  DATABASE_PROVIDER=${{ secrets.DATABASE_PROVIDER }}
                  SQLITE_DB_PATH=${{ secrets.SQLITE_DB_PATH }}
                  POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
                  COSMOSDB_CONNECTION_STRING=${{ secrets.COSMOSDB_CONNECTION_STRING }}

                  # Email Configuration
                  NOTIFICATION_PROVIDER=${{ secrets.NOTIFICATION_PROVIDER }}
                  EMAIL_FROM=${{ secrets.EMAIL_FROM }}
                  EMAIL_TO=${{ secrets.EMAIL_TO }}
                  EMAIL_HOST=${{ secrets.EMAIL_HOST }}
                  EMAIL_PORT=${{ secrets.EMAIL_PORT }}
                  EMAIL_USER=${{ secrets.EMAIL_USER }}
                  EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}
                  SENDGRID_API_KEY=${{ secrets.SENDGRID_API_KEY }}

                  # Microsoft Authentication
                  MS_USER_EMAIL=${{ secrets.MS_USER_EMAIL }}
                  MS_USER_PASSWORD=${{ secrets.MS_USER_PASSWORD }}
                  MS_SHAREPOINT_URL=${{ secrets.MS_SHAREPOINT_URL }}
                  EOF

            - name: Build project
              run: npm run build

            - name: Login to Microsoft
              run: npm run auth:login
              continue-on-error: false

            - name: Run Playwright tests
              run: npm run test:e2e
              env:
                  CI: true

            - name: Upload test results
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30

            - name: Upload authentication state
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: ms-auth-state
                  path: .auth/
                  retention-days: 7

            - name: Notify on failure
              if: failure()
              uses: actions/github-script@v7
              with:
                  script: |
                      github.rest.issues.create({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        title: 'âŒ Nightly Tests Failed - ' + new Date().toISOString().split('T')[0],
                        body: `Nightly test run failed!\n\n**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n**Date:** ${new Date().toUTCString()}`,
                        labels: ['test-failure', 'automated']
                      })
